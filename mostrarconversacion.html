<!doctype html>
<html lang="es">
  <head>
    <title>RestAura</title>
    <link rel="icon" href="icono.png">
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>

    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12 mt-2">
          <nav class="navbar px-0 justify-content-between">
            <a class="navbar-brand titulo" href="index.html">RestAura</a>

            <a id="refForo" href="foro.html">Foro</a>
            <a id="refConversacion" href="conversacion.html">Conversación</a>
            <a id="refRegistro" href="registro.html">Registro</a>
            <a id="refAdministracion" href="administracion.html" class="noMostrar">Administración</a>

            <form class="form-inline">
              <div id="bloqueIniciarSesion">
                <input id="correo" class="form-control mr-sm-2" type="email" placeholder="Correo electrónico..." aria-label="correoElectronico">
                <input id="contrasena" class="form-control mr-sm-2" type="password" placeholder="Contraseña..." aria-label="contrasena">
                <button id="sesion" class="btn btn-success my-2 my-sm-0 mr-sm-2" type="submit">Iniciar sesión</button>
              </div>
              <span id="mensajeBienvenida" class="noMostrar">Bienvenido <strong id="nombreUsuario"></strong> </span> 
              <button id="desconectar" class="btn btn-danger my-2 my-sm-0 mr-sm-2" type="submit">Desconectar</button>
            </form>
          </nav>

          <div class="separador"></div>
        </div>
      </div>
    </div>

    <div class="container">
        <div class="row">
          <!-- les falta el "noMostrar" -->
          <h1 id="correoTerapeuta"></h1>
          <div id="bloqueMensajesChat" class="col-md-12"></div>
        </div>

        <div class="row">
          <div id="bloqueEscribirChat" class="col-md-12 mt-4"></div>
        </div>
    </div>
      
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="index.js"></script>

    <script>
        $(document).ready(function(){
          getURLID();
          getAdministradorConversacion();
        });

        function getAdministradorConversacion(){
          var correoToCheck = correo;
          var esAdministrador = 0;

          $.ajax({
              url: 'main.php',
              type: 'POST',
              data: {functionToCall: 'getAdministradorConversacion'},
              success: function(data){
                  console.log(data);
                  console.log(data[0].administrador);

                  esAdministrador = data[0].administrador;

                  if(esAdministrador==1){
                    mostrarConversacionAdministrador(urlID);
                  }else{
                    mostrarConversacion(urlID);
                  }
              },
              error: function(data){
                  console.log(data);
              }
          })
        }
  
        function getURLID(){
          var url = window.location.href;
          urlID = url.split("=")[1];
          console.log(urlID);
          getTerapeuta(urlID);
          // mostrarConversacion(urlID);
        }
  
        function mostrarConversacion(urlID){
          var categoriaID = urlID;
          // alert(urlID);
          var contenidoChat = "";
          var contenidoFormulario = "";
          contenidoFormulario+=`
              <form>
                  <div class="form-group">
                      <label for="mensajesParaChat">Tu respuesta</label>
                      <textarea class="form-control" id="mensajesParaChat" rows="2" placeholder="Escribe aquí tu respuesta"></textarea>
                  </div>
                  <button id="enviarMensajesParaChat" type="submit" class="btn btn-primary">Enviar</button>
              </form>
          `; 
  
          $.ajax({
              url: 'main.php',
              type: 'POST',
              data: {functionToCall: 'mostrarConversacion', categoriaID: categoriaID},
              success: function(data){
                  console.log(data);
  
                  // console.log("titulo: " + titulo);
                  // contenidoChat+=`<h1>${titulo}</h1>`;
  
                  for(var i=0; i<data.length; i++){
                      var redactor = data[i].redactor;
                      var mensaje = data[i].mensaje;
                      var conectado = data[i].conectado;
  
                    if(conectado==1){
                        // conectado = "conectado";
                        contenidoChat+= `<p class="mt-1 filaConversacion"> <span class="puntoVerde"></span> <span class="correoP">${redactor.split("@")[0]}</span> <span>${mensaje}</span> </p>`;
                    }else{
                        // conectado = "desconectado";
                        contenidoChat+= `<p class="mt-1 filaConversacion"> <span class="puntoRojo"></span> <span class="correoP">${redactor.split("@")[0]}</span> <span>${mensaje}</span> </p>`;
                    }
  
                      // contenidoChat+= `<p class="mt-1">${mensaje} escrito por ${redactor} que está ${conectado}</p><br>`;
                  }
  
                  $("#bloqueMensajesChat").html(contenidoChat);
                  $("#bloqueEscribirChat").html(contenidoFormulario);
                  $("#enviarMensajesParaChat").click(escribirMensajeParaChat);
              },
              error: function(data){
                  console.log(data);
              }
          })
        }

        function mostrarConversacionAdministrador(urlID){
          var categoriaID = urlID;
          var contenidoChat = "";
          var contenidoFormulario = "";
          contenidoFormulario+=`
              <form>
                  <div class="form-group">
                      <label for="mensajesParaChat">Tu respuesta</label>
                      <textarea class="form-control" id="mensajesParaChat" rows="2" placeholder="Escribe aquí tu respuesta"></textarea>
                  </div>
                  <button id="enviarMensajesParaChat" type="submit" class="btn btn-primary">Enviar</button>
              </form>
          `; 
  
          $.ajax({
              url: 'main.php',
              type: 'POST',
              data: {functionToCall: 'mostrarConversacionAdministrador', categoriaID: categoriaID},
              success: function(data){
                  console.log(data);
  
                  // console.log("titulo: " + titulo);
                  // contenidoChat+=`<h1>${titulo}</h1>`;
  
                  for(var i=0; i<data.length; i++){
                      var redactor = data[i].redactor;
                      var mensaje = data[i].mensaje;
                      var conectado = data[i].conectado;
  
                    if(conectado==1){
                        // conectado = "conectado";
                        contenidoChat+= `<p class="mt-1 filaConversacion"> <span class="puntoVerde"></span> <span class="correoP">${redactor.split("@")[0]}</span> <span>${mensaje}</span> <button type="button" class="btn btn-danger eliminarComentario">Eliminar</button> </p>`;
                    }else{
                        // conectado = "desconectado";
                        contenidoChat+= `<p class="mt-1 filaConversacion"> <span class="puntoRojo"></span> <span class="correoP">${redactor.split("@")[0]}</span> <span>${mensaje}</span> <button type="button" class="btn btn-danger eliminarComentario">Eliminar</button> </p>`;
                    }
  
                      // contenidoChat+= `<p class="mt-1">${mensaje} escrito por ${redactor} que está ${conectado}</p><br>`;
                  }
  
                  $("#bloqueMensajesChat").html(contenidoChat);
                  $("#bloqueEscribirChat").html(contenidoFormulario);
                  $("#enviarMensajesParaChat").click(escribirMensajeParaChatAdministrador);

                  $(".eliminarComentario").click(function(){
                    // alert("hola");
                    var redactorToEliminar = "";
                    var comentarioToEliminar = "";
                    // console.log($(this).prev().prev().text());
                    // console.log($(this).prev().text());
                    redactorToEliminar = $(this).prev().prev().text();
                    comentarioToEliminar = $(this).prev().text();
                    eliminarComentarioConversacion(redactorToEliminar, comentarioToEliminar);
                  });
              },
              error: function(data){
                  console.log(data);
              }
          })
        }

        function getTerapeuta(urlID){
          var administradorID = urlID;
          // var correoTerapeuta = "";
          var contenidoCorreoTerapeuta = "";

          $.ajax({
              url: 'main.php',
              type: 'POST',
              data: {functionToCall: 'getTerapeuta', administradorID: administradorID},
              success: function(data){
                  // console.log(data);
                  var contenidoCorreoTerapeuta = data[0].correo;

                  // contenidoChat+=`<h1>${correoTerapeuta}</h1>`;
                  $("#correoTerapeuta").html("Conversación con " + contenidoCorreoTerapeuta.split("@")[0]);

                  // console.log(correoTerapeuta);
                  // return correoTerapeuta;
              },
              error: function(data){
                  console.log(data);
              }
          })
        }

        function escribirMensajeParaChat(){
          var url = window.location.href;
          var administradorID = url.split("=")[1];
          var mensaje = $("#mensajesParaChat").val();

          $.ajax({
              url: 'main.php',
              type: 'POST',
              data: {functionToCall: 'escribirMensajeParaChat', administradorID: administradorID, mensaje: mensaje},
              success: function(data){
                  console.log(data);
              },
              error: function(data){
                  console.log(data);
              }
          })

          event.preventDefault();
        }
        
        function escribirMensajeParaChatAdministrador(){
          var url = window.location.href;
          var usuarioID = url.split("=")[1];
          var mensaje = $("#mensajesParaChat").val();

          $.ajax({
              url: 'main.php',
              type: 'POST',
              data: {functionToCall: 'escribirMensajeParaChatAdministrador', usuarioID: usuarioID, mensaje: mensaje},
              success: function(data){
                  console.log(data);
              },
              error: function(data){
                  console.log(data);
              }
          })

          event.preventDefault();
        }

        function eliminarComentarioConversacion(redactorToEliminar, comentarioToEliminar){
          $.ajax({
            url: 'main.php',
            type: 'POST',
            data: {functionToCall: 'eliminarComentarioConversacion', redactorToEliminar: redactorToEliminar, comentarioToEliminar: comentarioToEliminar},
            success: function(data){
                console.log(data);
                // $("#URLConversaciones").html(data);
            },
            error: function(data){
                console.log(data);
            }
          })
        }

    </script>

  </body>
</html>